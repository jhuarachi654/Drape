<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRAPE — Virtual Try-On</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f0ece4;
    --surface: #e8e2d8;
    --dark: #1a1714;
    --mid: #6b6560;
    --accent: #c8a98a;
    --blue-soft: #b8c9d8;
    --white: #faf8f4;
    --border: rgba(26,23,20,0.12);
  }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 100;
    opacity: 0.5;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 40px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 0.2em;
    color: var(--dark);
  }

  .logo span { font-style: italic; color: var(--accent); }

  .status-bar {
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--mid);
    text-transform: uppercase;
  }

  .main {
    display: grid;
    grid-template-columns: 220px 1fr 280px;
    gap: 0;
    height: calc(100vh - 73px);
  }

  .panel-left {
    border-right: 1px solid var(--border);
    padding: 32px 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    overflow-y: auto;
  }

  .panel-label {
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--mid);
    margin-bottom: 12px;
  }

  .upload-zone {
    border: 1.5px dashed var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--white);
    position: relative;
    overflow: hidden;
  }

  .upload-zone:hover { border-color: var(--accent); background: rgba(200,169,138,0.06); }

  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon { font-size: 24px; margin-bottom: 8px; display: block; }
  .upload-zone p { font-size: 10px; color: var(--mid); letter-spacing: 0.05em; line-height: 1.5; }

  .garment-preview {
    width: 100%;
    aspect-ratio: 3/4;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid var(--border);
    display: none;
  }

  .garment-preview.visible { display: block; }

  .category-select {
    width: 100%;
    padding: 10px 14px;
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--dark);
    appearance: none;
    cursor: pointer;
    outline: none;
  }

  .try-btn {
    width: 100%;
    padding: 14px;
    background: var(--dark);
    color: var(--white);
    border: none;
    border-radius: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: auto;
  }

  .try-btn:hover:not(:disabled) { background: var(--accent); color: var(--dark); }
  .try-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .canvas-area {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0ece4;
    position: relative;
    overflow: hidden;
  }

  .model-container {
    position: relative;
    height: 85%;
    max-height: 700px;
    aspect-ratio: 2/3;
    border-radius: 0;
    overflow: hidden;
  }

  .model-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center center;
  }

  .result-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center center;
    opacity: 0;
    transition: opacity 0.6s ease;
  }

  .result-img.visible { opacity: 1; }

  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(240,236,228,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(4px);
  }

  .loading-overlay.active { opacity: 1; pointer-events: all; }

  .spinner {
    width: 32px;
    height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--dark);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-size: 10px; letter-spacing: 0.15em; color: var(--mid); text-transform: uppercase; }

  .panel-right {
    border-left: 1px solid var(--border);
    padding: 32px 24px;
    overflow-y: auto;
  }

  .api-config {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .api-config label {
    display: block;
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--mid);
    margin-bottom: 8px;
  }

  .api-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--dark);
    outline: none;
    transition: border-color 0.2s;
  }

  .api-input:focus { border-color: var(--accent); }

  .api-hint { font-size: 9px; color: var(--mid); margin-top: 6px; line-height: 1.5; }

  .result-section { margin-top: 8px; }

  .result-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .result-placeholder { font-size: 10px; color: var(--mid); text-align: center; letter-spacing: 0.05em; line-height: 1.8; }

  .download-btn {
    width: 100%;
    padding: 12px;
    background: transparent;
    color: var(--dark);
    border: 1.5px solid var(--dark);
    border-radius: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 12px;
    display: none;
  }

  .download-btn:hover { background: var(--dark); color: var(--white); }
  .download-btn.visible { display: block; }

  .error-msg {
    background: #fde8e8;
    border: 1px solid #f5c6c6;
    border-radius: 8px;
    padding: 12px;
    font-size: 10px;
    color: #c0392b;
    line-height: 1.5;
    display: none;
    margin-top: 12px;
  }

  .error-msg.visible { display: block; }

  .size-hint {
    font-size: 9px;
    color: var(--mid);
    margin-top: 6px;
    text-align: center;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  header, .panel-left, .canvas-area, .panel-right { animation: fadeUp 0.5s ease both; }
  .panel-left { animation-delay: 0.1s; }
  .canvas-area { animation-delay: 0.15s; }
  .panel-right { animation-delay: 0.2s; }
</style>
</head>
<body>

<header>
  <div class="logo">DR<span>A</span>PE</div>
  <div class="status-bar">Virtual Try-On Studio · MVP</div>
</header>

<div class="main">

  <!-- LEFT: Upload garment -->
  <div class="panel-left">
    <div>
      <div class="panel-label">01 — Garment</div>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="garmentInput" accept="image/*">
        <span class="upload-icon">＋</span>
        <p>Upload clothing<br>item photo</p>
      </div>
      <img class="garment-preview" id="garmentPreview" alt="Garment preview">
      <div class="size-hint" id="sizeHint"></div>
    </div>

    <div>
      <div class="panel-label">02 — Category</div>
      <select class="category-select" id="categorySelect">
        <option value="tops">Tops</option>
        <option value="bottoms">Bottoms</option>
        <option value="one-pieces">One-pieces / Dresses</option>
      </select>
    </div>

    <button class="try-btn" id="tryBtn" disabled>
      Try It On →
    </button>
  </div>

  <!-- CENTER: Model canvas -->
  <div class="canvas-area">
    <div class="model-container">
      <img class="model-img" id="modelImg" src="https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png" alt="Model">
      <img class="result-img" id="resultImg" alt="Try-on result">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Processing…</div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Config + result -->
  <div class="panel-right">
    <div class="api-config">
      <label>Fashn.ai API Key</label>
      <input
        class="api-input"
        type="text"
        id="apiKeyInput"
        placeholder="fa-xxxxxxxxxxxxxxxx"
      >
      <p class="api-hint">Your key is never stored or sent anywhere except directly to Fashn.ai.</p>
    </div>

    <div class="result-section">
      <div class="panel-label">Result</div>
      <div class="result-card" id="resultCard">
        <div class="result-placeholder">
          Upload a garment<br>and hit Try It On
        </div>
      </div>
      <button class="download-btn" id="downloadBtn">↓ Save Result</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </div>

</div>

<script>
  const garmentInput = document.getElementById('garmentInput');
  const garmentPreview = document.getElementById('garmentPreview');
  const tryBtn = document.getElementById('tryBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const resultImg = document.getElementById('resultImg');
  const downloadBtn = document.getElementById('downloadBtn');
  const errorMsg = document.getElementById('errorMsg');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const categorySelect = document.getElementById('categorySelect');
  const sizeHint = document.getElementById('sizeHint');

  // Model image — hosted on GitHub as a real PNG
  const MODEL_IMAGE_URL = 'https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png';

  let garmentDataUrl = null;

  // Compress image to stay well under Vercel's 4.5MB limit
  function compressImage(file, maxWidth = 1024, quality = 0.82) {
    return new Promise((resolve) => {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let { width, height } = img;
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
        URL.revokeObjectURL(url);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = url;
    });
  }

  garmentInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Show preview immediately from original
    const previewUrl = URL.createObjectURL(file);
    garmentPreview.src = previewUrl;
    garmentPreview.classList.add('visible');
    document.getElementById('uploadZone').style.display = 'none';
    sizeHint.textContent = 'Compressing…';
    tryBtn.disabled = true;

    // Compress for API
    garmentDataUrl = await compressImage(file);

    // Show compressed size
    const bytes = Math.round((garmentDataUrl.length * 3) / 4);
    const kb = Math.round(bytes / 1024);
    sizeHint.textContent = `Compressed: ~${kb}KB`;

    tryBtn.disabled = false;
  });

  tryBtn.addEventListener('click', async () => {
    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
      showError('Please enter your Fashn.ai API key in the right panel.');
      return;
    }
    if (!garmentDataUrl) {
      showError('Please upload a garment image first.');
      return;
    }

    errorMsg.classList.remove('visible');
    loadingOverlay.classList.add('active');
    tryBtn.disabled = true;

    try {
      // Step 1: Start the try-on job
      const runRes = await fetch('/api/tryon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model_image: MODEL_IMAGE_URL,
          garment_image: garmentDataUrl,
          category: categorySelect.value,
          api_key: apiKey,
        }),
      });

      let runData;
      const runText = await runRes.text();
      try {
        runData = JSON.parse(runText);
      } catch {
        throw new Error(`Server error: ${runText.slice(0, 200)}`);
      }

      if (!runRes.ok) {
        throw new Error(runData.detail || runData.error || `API error ${runRes.status}`);
      }

      const predictionId = runData.id;
      if (!predictionId) throw new Error('No prediction ID returned from Fashn.ai');

      // Step 2: Poll for result
      let result = null;
      for (let i = 0; i < 60; i++) {
        await sleep(2000);
        const statusRes = await fetch(`/api/status?id=${predictionId}&api_key=${encodeURIComponent(apiKey)}`);
        const statusText = await statusRes.text();
        let statusData;
        try {
          statusData = JSON.parse(statusText);
        } catch {
          throw new Error(`Status error: ${statusText.slice(0, 200)}`);
        }

        if (statusData.status === 'completed') {
          result = Array.isArray(statusData.output) ? statusData.output[0] : statusData.output;
          break;
        } else if (statusData.status === 'failed') {
          throw new Error(statusData.error || 'Processing failed on Fashn.ai');
        }
      }

      if (!result) throw new Error('Timed out waiting for result');

      // Show result
      resultImg.src = result;
      resultImg.classList.add('visible');
      downloadBtn.classList.add('visible');
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = result;
        a.download = 'drape-result.jpg';
        a.click();
      };

    } catch (err) {
      showError(`Error: ${err.message}`);
    } finally {
      loadingOverlay.classList.remove('active');
      tryBtn.disabled = false;
    }
  });

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('visible');
  }

  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }
</script>

</body>
</html>
