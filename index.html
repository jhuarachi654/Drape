<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRAPE — Virtual Try-On</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #f0ece4; --surface: #e8e2d8; --dark: #1a1714;
    --mid: #6b6560; --accent: #c8a98a; --white: #faf8f4;
    --border: rgba(26,23,20,0.12);
  }
  body { font-family: 'DM Mono', monospace; background: var(--bg); color: var(--dark); min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 100; opacity: 0.5;
  }
  header { display: flex; align-items: center; justify-content: space-between; padding: 24px 40px; border-bottom: 1px solid var(--border); }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; letter-spacing: 0.2em; color: var(--dark); }
  .logo span { font-style: italic; color: var(--accent); }
  .status-bar { font-size: 10px; letter-spacing: 0.15em; color: var(--mid); text-transform: uppercase; }
  .main { display: grid; grid-template-columns: 220px 1fr 280px; height: calc(100vh - 73px); }
  .panel-left { border-right: 1px solid var(--border); padding: 32px 24px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; }
  .panel-label { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--mid); margin-bottom: 12px; }
  .upload-zone { border: 1.5px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--white); position: relative; overflow: hidden; }
  .upload-zone:hover { border-color: var(--accent); background: rgba(200,169,138,0.06); }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 24px; margin-bottom: 8px; display: block; }
  .upload-zone p { font-size: 10px; color: var(--mid); letter-spacing: 0.05em; line-height: 1.5; }
  .img-preview { width: 100%; aspect-ratio: 3/4; border-radius: 10px; object-fit: cover; border: 1px solid var(--border); display: none; cursor: pointer; margin-top: 10px; }
  .img-preview.visible { display: block; }
  .category-select { width: 100%; padding: 10px 14px; background: var(--white); border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--dark); appearance: none; cursor: pointer; outline: none; }
  .try-btn { width: 100%; padding: 14px; background: var(--dark); color: var(--white); border: none; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; margin-top: auto; }
  .try-btn:hover:not(:disabled) { background: var(--accent); color: var(--dark); }
  .try-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .canvas-area { display: flex; align-items: center; justify-content: center; background: var(--bg); position: relative; overflow: hidden; }
  .model-container { position: relative; height: 85%; max-height: 700px; aspect-ratio: 2/3; overflow: hidden; }
  .model-img { width: 100%; height: 100%; object-fit: contain; object-position: center; }
  .result-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; opacity: 0; transition: opacity 0.6s ease; }
  .result-img.visible { opacity: 1; }
  .loading-overlay { position: absolute; inset: 0; background: rgba(240,236,228,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .loading-overlay.active { opacity: 1; pointer-events: all; }
  .spinner { width: 32px; height: 32px; border: 2px solid var(--border); border-top-color: var(--dark); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 10px; letter-spacing: 0.15em; color: var(--mid); text-transform: uppercase; }
  .loading-subtext { font-size: 9px; color: var(--mid); opacity: 0.6; letter-spacing: 0.05em; }
  .panel-right { border-left: 1px solid var(--border); padding: 32px 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
  .info-box { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; }
  .info-box-title { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .info-box p { font-size: 10px; color: var(--mid); line-height: 1.7; }
  .result-section { flex: 1; display: flex; flex-direction: column; gap: 10px; }
  .result-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
  .result-placeholder { font-size: 10px; color: var(--mid); text-align: center; letter-spacing: 0.05em; line-height: 1.8; }
  .download-btn { width: 100%; padding: 12px; background: transparent; color: var(--dark); border: 1.5px solid var(--dark); border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; display: none; }
  .download-btn:hover { background: var(--dark); color: var(--white); }
  .download-btn.visible { display: block; }
  .error-msg { background: #fde8e8; border: 1px solid #f5c6c6; border-radius: 8px; padding: 12px; font-size: 10px; color: #c0392b; line-height: 1.6; display: none; }
  .error-msg.visible { display: block; }
  .success-msg { background: #f0f7f0; border: 1px solid #c3dfc3; border-radius: 8px; padding: 12px; font-size: 10px; color: #2e7d32; line-height: 1.6; display: none; }
  .success-msg.visible { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  header, .panel-left, .canvas-area, .panel-right { animation: fadeUp 0.5s ease both; }
  .panel-left { animation-delay: 0.1s; } .canvas-area { animation-delay: 0.15s; } .panel-right { animation-delay: 0.2s; }
</style>
</head>
<body>

<header>
  <div class="logo">DR<span>A</span>PE</div>
  <div class="status-bar">VIRTUAL TRY-ON STUDIO · KOLORS AI</div>
</header>

<div class="main">

  <!-- ── LEFT PANEL ── -->
  <div class="panel-left">

    <div>
      <div class="panel-label">01 — YOUR PHOTO</div>
      <div class="upload-zone" id="personZone">
        <input type="file" id="personInput" accept="image/*">
        <span class="upload-icon">＋</span>
        <p>Full or half body<br>facing forward</p>
      </div>
      <img class="img-preview" id="personPreview" alt="Your photo" title="Click to remove">
    </div>

    <div>
      <div class="panel-label">02 — GARMENT</div>
      <div class="upload-zone" id="garmentZone">
        <input type="file" id="garmentInput" accept="image/*">
        <span class="upload-icon">＋</span>
        <p>Flat lay or white<br>background</p>
      </div>
      <img class="img-preview" id="garmentPreview" alt="Garment" title="Click to remove">
    </div>

    <div>
      <div class="panel-label">03 — CATEGORY</div>
      <select class="category-select" id="categorySelect">
        <option value="tops">Tops</option>
        <option value="bottoms">Bottoms</option>
        <option value="one-pieces">One-pieces / Dresses</option>
      </select>
    </div>

    <button class="try-btn" id="tryBtn" disabled>TRY IT ON →</button>

  </div>

  <!-- ── CENTER CANVAS ── -->
  <div class="canvas-area">
    <div class="model-container">
      <img class="model-img" id="modelImg"
        src="https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png"
        alt="Upload your photo">
      <img class="result-img" id="resultImg" alt="Try-on result">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Sending to Kolors…</div>
        <div class="loading-subtext">Free tier — may take 30–90 seconds</div>
      </div>
    </div>
  </div>

  <!-- ── RIGHT PANEL ── -->
  <div class="panel-right">

    <div class="info-box">
      <div class="info-box-title">How it works</div>
      <p>
        Upload your photo + a garment. Kolors AI (free, via Hugging Face) will render the try-on.<br><br>
        No API key needed. Images are never stored.
      </p>
    </div>

    <div class="result-section">
      <div class="panel-label">RESULT</div>
      <div class="result-card" id="resultCard">
        <div class="result-placeholder">Upload both photos<br>and hit Try It On</div>
      </div>
      <div class="success-msg" id="successMsg"></div>
      <div class="error-msg"   id="errorMsg"></div>
      <button class="download-btn" id="downloadBtn">↓ SAVE RESULT</button>
    </div>

  </div>
</div>

<script>
  // ── Elements ──────────────────────────────────────────────────
  const personInput   = document.getElementById('personInput');
  const personPreview = document.getElementById('personPreview');
  const personZone    = document.getElementById('personZone');
  const garmentInput  = document.getElementById('garmentInput');
  const garmentPreview= document.getElementById('garmentPreview');
  const garmentZone   = document.getElementById('garmentZone');
  const modelImg      = document.getElementById('modelImg');
  const tryBtn        = document.getElementById('tryBtn');
  const loadingOverlay= document.getElementById('loadingOverlay');
  const loadingText   = document.getElementById('loadingText');
  const resultImg     = document.getElementById('resultImg');
  const downloadBtn   = document.getElementById('downloadBtn');
  const errorMsg      = document.getElementById('errorMsg');
  const successMsg    = document.getElementById('successMsg');
  const resultCard    = document.getElementById('resultCard');

  let personB64  = null;
  let garmentB64 = null;

  // ── Resize + compress image to base64 (keeps requests small) ──
  function fileToBase64(file) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const MAX = 1024;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else       { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.82));
      };
      img.src = URL.createObjectURL(file);
    });
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('visible');
    successMsg.classList.remove('visible');
  }

  function showSuccess(msg) {
    successMsg.textContent = msg;
    successMsg.classList.add('visible');
    errorMsg.classList.remove('visible');
  }

  function updateBtn() {
    tryBtn.disabled = !(personB64 && garmentB64);
  }

  function setupUpload(input, preview, zone, onLoad) {
    // File chosen
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) { showError('File too large — max 10 MB.'); return; }

      const b64 = await fileToBase64(file);
      onLoad(b64);

      preview.src = b64;
      preview.classList.add('visible');
      zone.style.display = 'none';
      updateBtn();
    });

    // Click preview to remove
    preview.addEventListener('click', () => {
      onLoad(null);
      preview.src = '';
      preview.classList.remove('visible');
      zone.style.display = 'block';
      input.value = '';
      updateBtn();
    });
  }

  // ── Wire up uploads ───────────────────────────────────────────
  setupUpload(personInput, personPreview, personZone, (b64) => {
    personB64 = b64;
    // Mirror chosen photo in the center canvas
    modelImg.src = b64 || 'https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png';
    resultImg.classList.remove('visible');
    resultImg.src = '';
  });

  setupUpload(garmentInput, garmentPreview, garmentZone, (b64) => {
    garmentB64 = b64;
  });

  // ── Try-on ────────────────────────────────────────────────────
  tryBtn.addEventListener('click', async () => {
    if (!personB64 || !garmentB64) return;

    // Reset UI
    errorMsg.classList.remove('visible');
    successMsg.classList.remove('visible');
    resultImg.classList.remove('visible');
    downloadBtn.classList.remove('visible');
    resultCard.innerHTML = '<div class="result-placeholder">Processing…</div>';
    loadingOverlay.classList.add('active');
    loadingText.textContent = 'Sending to Kolors…';
    tryBtn.disabled = true;

    try {
      const res = await fetch('/api/tryon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          person_image_b64:  personB64,
          garment_image_b64: garmentB64,
        }),
      });

      const data = await res.json();

      if (!res.ok || data.error) {
        throw new Error(data.error || 'Unknown error from API.');
      }

      // data.image may be { url: '...' } or a plain string
      const imgSrc = typeof data.image === 'string'
        ? data.image
        : data.image?.url;

      if (!imgSrc) throw new Error('No image returned from Kolors.');

      // Show in canvas
      resultImg.src = imgSrc;
      resultImg.classList.add('visible');

      // Show in right panel
      resultCard.innerHTML = `<img src="${imgSrc}" style="width:100%;border-radius:8px;" alt="Try-on result">`;

      // Download
      downloadBtn.classList.add('visible');
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = imgSrc;
        a.download = 'drape-result.jpg';
        a.target = '_blank';
        a.click();
      };

      showSuccess('✓ Try-on complete!');

    } catch (err) {
      console.error(err);
      showError(
        err.message.includes('overloaded')
          ? 'Kolors is busy right now. Wait a moment and try again.'
          : `Error: ${err.message}`
      );
    } finally {
      loadingOverlay.classList.remove('active');
      updateBtn();
    }
  });
</script>
</body>
</html>
