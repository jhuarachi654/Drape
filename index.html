<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRAPE ‚Äî Virtual Try-On</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #f0ece4; --surface: #e8e2d8; --dark: #1a1714;
    --mid: #6b6560; --accent: #c8a98a; --white: #faf8f4;
    --border: rgba(26,23,20,0.12);
  }
  body { font-family: 'DM Mono', monospace; background: var(--bg); color: var(--dark); min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 100; opacity: 0.5;
  }
  header { display: flex; align-items: center; justify-content: space-between; padding: 24px 40px; border-bottom: 1px solid var(--border); }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; letter-spacing: 0.2em; color: var(--dark); }
  .logo span { font-style: italic; color: var(--accent); }
  .status-bar { font-size: 10px; letter-spacing: 0.15em; color: var(--mid); text-transform: uppercase; }
  .main { display: grid; grid-template-columns: 220px 1fr 280px; height: calc(100vh - 73px); }
  .panel-left { border-right: 1px solid var(--border); padding: 32px 24px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; }
  .panel-label { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--mid); margin-bottom: 12px; }
  .upload-zone { border: 1.5px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--white); position: relative; overflow: hidden; }
  .upload-zone:hover { border-color: var(--accent); background: rgba(200,169,138,0.06); }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 24px; margin-bottom: 8px; display: block; }
  .upload-zone p { font-size: 10px; color: var(--mid); letter-spacing: 0.05em; line-height: 1.5; }
  .garment-preview { width: 100%; aspect-ratio: 3/4; border-radius: 10px; object-fit: cover; border: 1px solid var(--border); display: none; }
  .garment-preview.visible { display: block; }
  .category-select { width: 100%; padding: 10px 14px; background: var(--white); border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--dark); appearance: none; cursor: pointer; outline: none; }
  .try-btn { width: 100%; padding: 14px; background: var(--dark); color: var(--white); border: none; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; margin-top: auto; }
  .try-btn:hover:not(:disabled) { background: var(--accent); color: var(--dark); }
  .try-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .canvas-area { display: flex; align-items: center; justify-content: center; background: var(--bg); position: relative; overflow: hidden; }
  .model-container { position: relative; height: 85%; max-height: 700px; aspect-ratio: 2/3; overflow: hidden; }
  .model-img { width: 100%; height: 100%; object-fit: contain; object-position: center; }
  .result-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; opacity: 0; transition: opacity 0.6s ease; }
  .result-img.visible { opacity: 1; }
  .loading-overlay { position: absolute; inset: 0; background: rgba(240,236,228,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .loading-overlay.active { opacity: 1; pointer-events: all; }
  .spinner { width: 32px; height: 32px; border: 2px solid var(--border); border-top-color: var(--dark); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 10px; letter-spacing: 0.15em; color: var(--mid); text-transform: uppercase; }
  .panel-right { border-left: 1px solid var(--border); padding: 32px 24px; overflow-y: auto; }
  .api-config { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .api-config label { display: block; font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--mid); margin-bottom: 8px; }
  .api-input { width: 100%; padding: 10px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--dark); outline: none; transition: border-color 0.2s; }
  .api-input:focus { border-color: var(--accent); }
  .api-hint { font-size: 9px; color: var(--mid); margin-top: 6px; line-height: 1.5; }
  .result-section { margin-top: 8px; }
  .result-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
  .result-placeholder { font-size: 10px; color: var(--mid); text-align: center; letter-spacing: 0.05em; line-height: 1.8; }
  .download-btn { width: 100%; padding: 12px; background: transparent; color: var(--dark); border: 1.5px solid var(--dark); border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; margin-top: 12px; display: none; }
  .download-btn:hover { background: var(--dark); color: var(--white); }
  .download-btn.visible { display: block; }
  .error-msg { background: #fde8e8; border: 1px solid #f5c6c6; border-radius: 8px; padding: 12px; font-size: 10px; color: #c0392b; line-height: 1.5; display: none; margin-top: 12px; }
  .error-msg.visible { display: block; }
  .success-msg { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 12px; font-size: 10px; color: #2e7d32; line-height: 1.5; display: none; margin-top: 12px; }
  .success-msg.visible { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  header, .panel-left, .canvas-area, .panel-right { animation: fadeUp 0.5s ease both; }
  .panel-left { animation-delay: 0.1s; } .canvas-area { animation-delay: 0.15s; } .panel-right { animation-delay: 0.2s; }
</style>
</head>
<body>
<header>
  <div class="logo">DR<span>A</span>PE</div>
  <div class="status-bar">VIRTUAL TRY-ON STUDIO ¬∑ MVP</div>
</header>
<div class="main">
  <div class="panel-left">
    <div>
      <div class="panel-label">01 ‚Äî GARMENT</div>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="garmentInput" accept="image/*">
        <span class="upload-icon">Ôºã</span>
        <p>Upload clothing<br>item photo</p>
      </div>
      <img class="garment-preview" id="garmentPreview" alt="Garment preview">
    </div>
    <div>
      <div class="panel-label">02 ‚Äî CATEGORY</div>
      <select class="category-select" id="categorySelect">
        <option value="tops">Tops</option>
        <option value="bottoms">Bottoms</option>
        <option value="one-pieces">One-pieces / Dresses</option>
      </select>
    </div>
    <button class="try-btn" id="tryBtn" disabled>TRY IT ON ‚Üí</button>
  </div>

  <div class="canvas-area">
    <div class="model-container">
      <img class="model-img" id="modelImg"
        src="https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png"
        alt="Model">
      <img class="result-img" id="resultImg" alt="Try-on result">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Uploading‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="panel-right">
    <div class="api-config">
      <label>FASHN.AI API KEY</label>
      <input class="api-input" type="text" id="apiKeyInput" placeholder="fa-xxxxxxxxxxxxxxxx">
      <p class="api-hint">Your key is never stored or sent anywhere except directly to Fashn.ai.</p>
    </div>
    <div class="result-section">
      <div class="panel-label">RESULT</div>
      <div class="result-card" id="resultCard">
        <div class="result-placeholder">Upload a garment<br>and hit Try It On</div>
      </div>
      <div class="success-msg" id="successMsg"></div>
      <div class="error-msg" id="errorMsg"></div>
      <button class="download-btn" id="downloadBtn">‚Üì SAVE RESULT</button>
    </div>
  </div>
</div>

<script>
  const garmentInput   = document.getElementById('garmentInput');
  const garmentPreview = document.getElementById('garmentPreview');
  const tryBtn         = document.getElementById('tryBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingText    = document.getElementById('loadingText');
  const resultImg      = document.getElementById('resultImg');
  const downloadBtn    = document.getElementById('downloadBtn');
  const errorMsg       = document.getElementById('errorMsg');
  const successMsg     = document.getElementById('successMsg');
  const apiKeyInput    = document.getElementById('apiKeyInput');
  const categorySelect = document.getElementById('categorySelect');
  const uploadZone     = document.getElementById('uploadZone');

  const MODEL_IMAGE_URL = 'https://raw.githubusercontent.com/jhuarachi654/Drape/main/johanna%202_6%201.png';
  
  // Your ImgBB API key
  const IMGBB_API_KEY = '9272cae259ec202c877e982b848b3e16';
  
  // CORS proxy to avoid CORS issues
  const CORS_PROXY = 'https://corsproxy.io/?';

  let garmentFile = null;

  // Test ImgBB connection on page load
  window.addEventListener('load', () => {
    console.log('üîß Testing ImgBB connection...');
    testImgBB();
  });

  async function testImgBB() {
    try {
      const testFormData = new FormData();
      // Create a tiny test image (1x1 pixel)
      const testBlob = new Blob(['R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'], {type: 'image/gif'});
      testFormData.append('image', testBlob, 'test.gif');
      
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: testFormData
      });
      
      if (response.ok) {
        console.log('‚úÖ ImgBB connection successful');
      } else {
        console.log('‚ö†Ô∏è ImgBB test failed, but will try on actual upload');
      }
    } catch (err) {
      console.log('‚ö†Ô∏è ImgBB test error (non-critical):', err.message);
    }
  }

  garmentInput.addEventListener('change', (e) => {
    garmentFile = e.target.files[0];
    if (!garmentFile) return;
    
    // Check file size (max 10MB)
    if (garmentFile.size > 10 * 1024 * 1024) {
      showError('File too large. Please upload an image under 10MB.');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      garmentPreview.src = e.target.result;
      garmentPreview.classList.add('visible');
      uploadZone.style.display = 'none';
    };
    reader.readAsDataURL(garmentFile);
    tryBtn.disabled = false;
    showSuccess('Garment uploaded successfully!');
  });

  // Reset upload zone when clicking on preview
  garmentPreview.addEventListener('click', () => {
    garmentInput.value = '';
    garmentPreview.classList.remove('visible');
    garmentPreview.src = '';
    uploadZone.style.display = 'block';
    garmentFile = null;
    tryBtn.disabled = true;
    successMsg.classList.remove('visible');
  });

  async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append('image', file);

    showSuccess('Uploading to ImgBB...');
    
    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error('Failed to upload image: ' + error);
    }

    const data = await response.json();
    return data.data.url;
  }

  async function callFashnAI(endpoint, apiKey, body = null) {
    const url = endpoint === 'run' 
      ? 'https://api.fashn.ai/v1/run'
      : `https://api.fashn.ai/v1/status/${body}`;
    
    const options = {
      method: body ? 'POST' : 'GET',
      headers: {
        'Content-Type': 'application/json',
        'api-key': apiKey
      }
    };
    
    if (body && endpoint === 'run') {
      options.body = JSON.stringify(body);
    }
    
    // Try direct connection first
    try {
      const response = await fetch(url, options);
      if (response.ok) return response;
      console.log('Direct connection failed, trying with proxy...');
    } catch (err) {
      console.log('Direct connection error:', err.message);
    }
    
    // If direct fails, try with CORS proxy
    const proxyUrl = CORS_PROXY + encodeURIComponent(url);
    const proxyOptions = {...options};
    if (options.body) {
      proxyOptions.body = options.body;
    }
    
    return await fetch(proxyUrl, proxyOptions);
  }

  tryBtn.addEventListener('click', async () => {
    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) { showError('Please enter your Fashn.ai API key.'); return; }
    if (!garmentFile) { showError('Please upload a garment image first.'); return; }

    errorMsg.classList.remove('visible');
    successMsg.classList.remove('visible');
    loadingOverlay.classList.add('active');
    loadingText.textContent = 'Uploading garment to ImgBB‚Ä¶';
    tryBtn.disabled = true;

    try {
      // Upload to ImgBB first
      const garmentUrl = await uploadToImgBB(garmentFile);
      console.log('‚úÖ Uploaded to ImgBB:', garmentUrl);
      showSuccess('‚úÖ Image uploaded to ImgBB');

      // Map categories for Fashn.ai
      const categoryMap = {
        'tops': 'tops',
        'bottoms': 'bottoms',
        'one-pieces': 'dresses'
      };

      // Start the Fashn.ai process
      loadingText.textContent = 'Starting virtual try-on with Fashn.ai‚Ä¶';
      showSuccess('‚è≥ Calling Fashn.ai API...');
      
      const runResponse = await callFashnAI('run', apiKey, {
        model_image: MODEL_IMAGE_URL,
        garment_image: garmentUrl,
        category: categoryMap[categorySelect.value] || 'tops',
        garment_photo_type: 'auto',
        mode: 'quality'
      });

      const runData = await runResponse.json();
      console.log('‚úÖ Fashn.ai response:', runData);
      
      if (!runResponse.ok) {
        throw new Error(runData.message || runData.error || 'Failed to start try-on');
      }

      const predictionId = runData.id;
      if (!predictionId) throw new Error('No prediction ID returned');
      
      showSuccess(`‚è≥ Processing started (ID: ${predictionId.substring(0,8)}...)`);

      // Poll for result
      loadingText.textContent = 'Rendering virtual try-on‚Ä¶';
      let result = null;
      let attempts = 0;
      const maxAttempts = 30;
      
      while (attempts < maxAttempts && !result) {
        await new Promise(r => setTimeout(r, 2000));
        attempts++;
        
        const statusResponse = await callFashnAI('status', apiKey, predictionId);
        
        const statusData = await statusResponse.json();
        console.log(`‚è≥ Attempt ${attempts}:`, statusData);

        if (!statusResponse.ok) {
          throw new Error(statusData.error || 'Status check failed');
        }

        if (statusData.status === 'completed') {
          // Handle different response formats
          if (Array.isArray(statusData.output)) {
            result = statusData.output[0];
          } else if (typeof statusData.output === 'string') {
            result = statusData.output;
          } else if (statusData.output?.url) {
            result = statusData.output.url;
          } else if (statusData.url) {
            result = statusData.url;
          }
          break;
        } else if (statusData.status === 'failed') {
          throw new Error(statusData.error || 'Processing failed');
        } else {
          loadingText.textContent = `Rendering... (${attempts}/${maxAttempts})`;
        }
      }

      if (!result) {
        throw new Error('Timed out waiting for result');
      }

      console.log('‚úÖ Got result:', result);
      showSuccess('‚úÖ Virtual try-on complete!');
      
      // Display the result
      resultImg.src = result;
      resultImg.classList.add('visible');
      
      // Update result card
      const resultCard = document.getElementById('resultCard');
      resultCard.innerHTML = `<img src="${result}" style="width: 100%; border-radius: 8px;" alt="Try-on result">`;
      
      downloadBtn.classList.add('visible');
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = result;
        a.download = 'drape-result.jpg';
        a.click();
      };

    } catch (err) {
      console.error('‚ùå Error:', err);
      showError(`Error: ${err.message}`);
    } finally {
      loadingOverlay.classList.remove('active');
      tryBtn.disabled = false;
    }
  });

  function showError(msg) { 
    errorMsg.textContent = msg; 
    errorMsg.classList.add('visible');
    successMsg.classList.remove('visible');
    setTimeout(() => {
      errorMsg.classList.remove('visible');
    }, 10000);
  }
  
  function showSuccess(msg) {
    successMsg.textContent = msg;
    successMsg.classList.add('visible');
    setTimeout(() => {
      successMsg.classList.remove('visible');
    }, 5000);
  }
</script>
</body>
</html>
