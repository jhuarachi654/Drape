<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRAPE â€” My Closet</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #f0ece4; --dark: #1a1714; --mid: #6b6560;
    --accent: #c8a98a; --white: #faf8f4; --border: rgba(26,23,20,0.1);
    --drawer-h: 190px;
  }
  body { font-family: 'DM Mono', monospace; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:500; background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E"); opacity:0.6; }

  header { display:flex; align-items:center; justify-content:space-between; padding:16px 28px; border-bottom:1px solid var(--border); flex-shrink:0; background:var(--bg); z-index:20; }
  .logo { font-family:'Cormorant Garamond',serif; font-size:24px; font-weight:300; letter-spacing:0.22em; }
  .logo em { font-style:italic; color:var(--accent); }
  .header-right { display:flex; align-items:center; gap:10px; }
  .hbtn { font-size:9px; letter-spacing:0.13em; text-transform:uppercase; color:var(--mid); cursor:pointer; border:1px solid var(--border); padding:6px 13px; border-radius:100px; background:var(--white); transition:all 0.2s; white-space:nowrap; }
  .hbtn:hover { border-color:var(--accent); color:var(--dark); }
  #modelFileInput, #itemFileInput { display:none; }
  .outfit-label { font-size:9px; letter-spacing:0.1em; color:var(--mid); text-transform:uppercase; max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .stage { flex:1; display:grid; grid-template-columns:72px 1fr 72px; align-items:center; overflow:hidden; position:relative; }

  .arrow-col { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; padding:12px 0; height:100%; }
  .cat-block { display:flex; flex-direction:column; align-items:center; gap:5px; }
  .cat-label { font-size:7px; letter-spacing:0.2em; text-transform:uppercase; color:var(--mid); writing-mode:vertical-rl; transform:rotate(180deg); }
  .abtn { width:34px; height:34px; border-radius:50%; border:1px solid var(--border); background:var(--white); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; color:var(--dark); transition:all 0.15s; }
  .abtn:hover { background:var(--accent); border-color:var(--accent); color:var(--white); }
  .ctr { font-size:8px; color:var(--mid); text-align:center; min-width:26px; }

  .canvas-wrap { position:relative; height:100%; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .model-stack { position:relative; height:90%; max-height:600px; aspect-ratio:9/16; }
  #modelBase { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:1; display:none; }
  .empty-model { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; border:1.5px dashed var(--border); border-radius:20px; background:var(--white); cursor:pointer; z-index:0; }
  .empty-model p { font-size:10px; color:var(--mid); text-align:center; line-height:1.7; }
  .empty-model span { font-size:26px; }

  /* â”€â”€ GARMENT LAYER â”€â”€ */
  /* Each layer is absolute over the stack, full size, pointer-events off by default */
  .dlayer { position:absolute; inset:0; display:none; pointer-events:none; }
  .dlayer.on { display:block; }

  /* The inner "object" is what actually moves/scales/rotates */
  .dlayer .gobj {
    position:absolute;
    /* default: centered, full height */
    width:100%; height:100%;
    top:0; left:0;
    transform-origin: center center;
    pointer-events:auto;
    cursor:grab;
  }
  .dlayer .gobj:active { cursor:grabbing; }

  .dlayer .gobj img {
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
    display:block;
  }

  /* selection box drawn on top of img */
  .dlayer .gobj .sel-box {
    display:none;
    position:absolute; inset:0;
    border:1.5px solid rgba(200,169,138,0.9);
    border-radius:4px;
    pointer-events:none;
  }
  .dlayer.selected .gobj .sel-box { display:block; }

  /* â”€â”€ CORNER HANDLES â”€â”€ */
  .handle {
    position:absolute;
    width:14px; height:14px;
    border-radius:50%;
    background:var(--white);
    border:1.5px solid var(--dark);
    pointer-events:auto;
    z-index:10;
  }
  /* scale handles â€” corners */
  .h-tl { top:-7px;  left:-7px;  cursor:nw-resize; }
  .h-tr { top:-7px;  right:-7px; cursor:ne-resize; }
  .h-bl { bottom:-7px; left:-7px;  cursor:sw-resize; }
  .h-br { bottom:-7px; right:-7px; cursor:se-resize; }

  /* rotate handle â€” above top-right, styled differently */
  .h-rot {
    top:-32px; right:-7px;
    background:var(--accent);
    border-color:var(--white);
    cursor:crosshair;
    display:flex; align-items:center; justify-content:center;
    font-size:9px; color:var(--white);
  }
  /* line from rotate handle to corner */
  .h-rot::before {
    content:''; position:absolute;
    bottom:-11px; left:50%; transform:translateX(-50%);
    width:1px; height:10px;
    background:rgba(200,169,138,0.7);
  }

  /* hide handles when not selected */
  .dlayer:not(.selected) .handle { display:none; }

  /* â”€â”€ FLOATING MINI TOOLBAR â”€â”€ */
  #floatToolbar {
    position:fixed; display:none; align-items:center; gap:3px;
    background:var(--dark); border-radius:100px;
    padding:6px 12px; z-index:400;
    box-shadow:0 6px 24px rgba(0,0,0,0.28);
    transform:translateX(-50%);
  }
  #floatToolbar.visible { display:flex; }
  .ft-divider { width:1px; height:14px; background:rgba(255,255,255,0.15); margin:0 3px; }
  .ft-btn { background:transparent; border:none; cursor:pointer; color:rgba(255,255,255,0.65); font-size:12px; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
  .ft-btn:hover { background:rgba(255,255,255,0.12); color:#fff; }
  .ft-btn.danger:hover { background:rgba(220,60,60,0.3); color:#ff8070; }
  .ft-cat { font-size:8px; letter-spacing:0.12em; text-transform:uppercase; color:rgba(255,255,255,0.35); padding:0 6px; }

  /* DRAWER */
  .drawer { height:var(--drawer-h); border-top:1px solid var(--border); background:var(--white); flex-shrink:0; display:flex; flex-direction:column; overflow:hidden; transition:height 0.35s cubic-bezier(0.4,0,0.2,1); z-index:10; }
  .drawer.collapsed { height:40px; }
  .drawer-header { display:flex; align-items:center; justify-content:space-between; padding:0 20px; height:40px; flex-shrink:0; cursor:pointer; user-select:none; }
  .drawer-title { font-size:9px; letter-spacing:0.2em; text-transform:uppercase; color:var(--mid); }
  .drawer-toggle { font-size:10px; color:var(--mid); transition:transform 0.3s; }
  .drawer.collapsed .drawer-toggle { transform:rotate(180deg); }
  .drawer-tabs { display:flex; border-bottom:1px solid var(--border); padding:0 20px; flex-shrink:0; }
  .drawer-tab { font-size:8px; letter-spacing:0.15em; text-transform:uppercase; padding:7px 14px; cursor:pointer; color:var(--mid); border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.2s; }
  .drawer-tab.active { color:var(--dark); border-bottom-color:var(--accent); }
  .drawer-body { flex:1; overflow-x:auto; overflow-y:hidden; display:flex; align-items:center; gap:10px; padding:10px 20px; }
  .drawer-body::-webkit-scrollbar { height:3px; }
  .drawer-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .inv-item { flex-shrink:0; width:68px; height:90px; border-radius:10px; border:1.5px solid var(--border); overflow:hidden; cursor:pointer; background:var(--bg); transition:all 0.15s; position:relative; }
  .inv-item:hover { border-color:var(--accent); transform:translateY(-2px); }
  .inv-item.active { border-color:var(--dark); box-shadow:0 0 0 1px var(--dark); }
  .inv-item img { width:100%; height:100%; object-fit:cover; }
  .inv-item .rx { position:absolute; top:3px; right:3px; width:15px; height:15px; border-radius:50%; background:rgba(26,23,20,0.65); color:#fff; font-size:8px; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.15s; cursor:pointer; z-index:2; }
  .inv-item:hover .rx { opacity:1; }
  .add-btn { flex-shrink:0; width:68px; height:90px; border-radius:10px; border:1.5px dashed var(--border); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; cursor:pointer; transition:all 0.15s; color:var(--mid); }
  .add-btn:hover { border-color:var(--accent); color:var(--accent); }
  .add-btn span { font-size:18px; }
  .add-btn p { font-size:8px; letter-spacing:0.08em; text-align:center; }

  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  header{animation:fadeUp 0.4s ease both}
  .stage{animation:fadeUp 0.4s ease 0.08s both}
  .drawer{animation:fadeUp 0.4s ease 0.15s both}
</style>
</head>
<body>

<header>
  <div class="logo">DR<em>A</em>PE</div>
  <div class="header-right">
    <label class="hbtn" for="modelFileInput">ï¼‹ Set my photo</label>
    <input type="file" id="modelFileInput" accept="image/*">
    <span class="outfit-label" id="outfitLabel">no outfit selected</span>
  </div>
</header>

<div class="stage">
  <div class="arrow-col">
    <div class="cat-block">
      <span class="cat-label">Top</span>
      <button class="abtn" onclick="swipe('tops',-1)">â€¹</button>
      <span class="ctr" id="ctrTops">â€”</span>
      <button class="abtn" onclick="swipe('tops',1)">â€º</button>
    </div>
    <div class="cat-block">
      <span class="cat-label">Bottom</span>
      <button class="abtn" onclick="swipe('bottoms',-1)">â€¹</button>
      <span class="ctr" id="ctrBottoms">â€”</span>
      <button class="abtn" onclick="swipe('bottoms',1)">â€º</button>
    </div>
    <div class="cat-block">
      <span class="cat-label">Shoes</span>
      <button class="abtn" onclick="swipe('shoes',-1)">â€¹</button>
      <span class="ctr" id="ctrShoes">â€”</span>
      <button class="abtn" onclick="swipe('shoes',1)">â€º</button>
    </div>
  </div>

  <div class="canvas-wrap" id="canvasWrap">
    <div class="model-stack" id="modelStack">
      <div class="empty-model" id="emptyModel" onclick="document.getElementById('modelFileInput').click()">
        <span>ðŸ‘¤</span><p>Tap to set<br>your photo</p>
      </div>
      <img id="modelBase" alt="Model">

      <!-- Each layer: dlayer > gobj > img + sel-box + handles -->
      <div class="dlayer" id="layerTops" data-cat="tops">
        <div class="gobj" id="gobjTops">
          <img id="imgTops" alt="Top">
          <div class="sel-box"></div>
          <div class="handle h-tl" data-dir="scale" data-corner="tl"></div>
          <div class="handle h-tr" data-dir="scale" data-corner="tr"></div>
          <div class="handle h-bl" data-dir="scale" data-corner="bl"></div>
          <div class="handle h-br" data-dir="scale" data-corner="br"></div>
          <div class="handle h-rot" data-dir="rotate" title="Drag to rotate">â†»</div>
        </div>
      </div>

      <div class="dlayer" id="layerBottoms" data-cat="bottoms">
        <div class="gobj" id="gobjBottoms">
          <img id="imgBottoms" alt="Bottom">
          <div class="sel-box"></div>
          <div class="handle h-tl" data-dir="scale" data-corner="tl"></div>
          <div class="handle h-tr" data-dir="scale" data-corner="tr"></div>
          <div class="handle h-bl" data-dir="scale" data-corner="bl"></div>
          <div class="handle h-br" data-dir="scale" data-corner="br"></div>
          <div class="handle h-rot" data-dir="rotate" title="Drag to rotate">â†»</div>
        </div>
      </div>

      <div class="dlayer" id="layerShoes" data-cat="shoes">
        <div class="gobj" id="gobjShoes">
          <img id="imgShoes" alt="Shoes">
          <div class="sel-box"></div>
          <div class="handle h-tl" data-dir="scale" data-corner="tl"></div>
          <div class="handle h-tr" data-dir="scale" data-corner="tr"></div>
          <div class="handle h-bl" data-dir="scale" data-corner="bl"></div>
          <div class="handle h-br" data-dir="scale" data-corner="br"></div>
          <div class="handle h-rot" data-dir="rotate" title="Drag to rotate">â†»</div>
        </div>
      </div>
    </div>
  </div>

  <div></div>
</div>

<!-- Minimal floating toolbar: layer name, z-order, reset, remove -->
<div id="floatToolbar">
  <span class="ft-cat" id="ftLabel">top</span>
  <div class="ft-divider"></div>
  <button class="ft-btn" title="Send backward" onclick="zShift(-1)">â†“</button>
  <button class="ft-btn" title="Bring forward"  onclick="zShift(1)">â†‘</button>
  <div class="ft-divider"></div>
  <button class="ft-btn" title="Reset"  onclick="resetSelected()">â†º</button>
  <button class="ft-btn danger" title="Remove" onclick="clearSelected()">âœ•</button>
</div>

<div class="drawer" id="drawer">
  <div class="drawer-header" onclick="toggleDrawer()">
    <span class="drawer-title">My Wardrobe</span>
    <span class="drawer-toggle">â–²</span>
  </div>
  <div class="drawer-tabs">
    <div class="drawer-tab active" onclick="switchTab('tops')"    id="dtab-tops">Tops</div>
    <div class="drawer-tab"        onclick="switchTab('bottoms')" id="dtab-bottoms">Bottoms</div>
    <div class="drawer-tab"        onclick="switchTab('shoes')"   id="dtab-shoes">Shoes</div>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
</div>

<input type="file" id="itemFileInput" accept="image/*">

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wardrobe = { tops:[], bottoms:[], shoes:[] };
const current  = { tops:-1, bottoms:-1, shoes:-1 };
let activeTab  = 'tops';
let selectedCat = null;
let zOrder = ['tops','bottoms','shoes'];

// Per-layer: x/y = translation in px from center, scale, rotate in deg
const T = {
  tops:    { x:0, y:0, scale:1, rotate:0 },
  bottoms: { x:0, y:0, scale:1, rotate:0 },
  shoes:   { x:0, y:0, scale:1, rotate:0 },
};

const modelBase     = document.getElementById('modelBase');
const emptyModel    = document.getElementById('emptyModel');
const outfitLabel   = document.getElementById('outfitLabel');
const drawerBody    = document.getElementById('drawerBody');
const itemFileInput = document.getElementById('itemFileInput');
const floatToolbar  = document.getElementById('floatToolbar');
const modelStack    = document.getElementById('modelStack');

const layers = { tops: document.getElementById('layerTops'),    bottoms: document.getElementById('layerBottoms'),    shoes: document.getElementById('layerShoes') };
const gobjs  = { tops: document.getElementById('gobjTops'),     bottoms: document.getElementById('gobjBottoms'),     shoes: document.getElementById('gobjShoes') };
const imgs   = { tops: document.getElementById('imgTops'),      bottoms: document.getElementById('imgBottoms'),      shoes: document.getElementById('imgShoes') };
const ctrs   = { tops: document.getElementById('ctrTops'),      bottoms: document.getElementById('ctrBottoms'),      shoes: document.getElementById('ctrShoes') };

// â”€â”€ Model photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('modelFileInput').addEventListener('change', e => {
  const f = e.target.files[0]; if (!f) return;
  modelBase.src = URL.createObjectURL(f);
  modelBase.style.display = 'block';
  emptyModel.style.display = 'none';
});

// â”€â”€ Apply transform to a gobj â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTransform(cat) {
  const t = T[cat];
  gobjs[cat].style.transform = `translate(${t.x}px, ${t.y}px) scale(${t.scale}) rotate(${t.rotate}deg)`;
}

function applyZOrder() {
  zOrder.forEach((cat, i) => layers[cat].style.zIndex = i + 2);
}

// â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function positionToolbar(cat) {
  const rect = gobjs[cat].getBoundingClientRect();
  floatToolbar.style.left = (rect.left + rect.width / 2) + 'px';
  floatToolbar.style.top  = Math.max(56, rect.top - 52) + 'px';
}

function showToolbar(cat) {
  document.getElementById('ftLabel').textContent = cat.slice(0,-1);
  positionToolbar(cat);
  floatToolbar.classList.add('visible');
}

function hideToolbar() { floatToolbar.classList.remove('visible'); }

function selectLayer(cat) {
  selectedCat = cat;
  Object.keys(layers).forEach(c => layers[c].classList.remove('selected'));
  layers[cat].classList.add('selected');
  showToolbar(cat);
}

function deselectAll() {
  selectedCat = null;
  Object.keys(layers).forEach(c => layers[c].classList.remove('selected'));
  hideToolbar();
}

// Click canvas bg â†’ deselect
document.getElementById('canvasWrap').addEventListener('mousedown', e => {
  const clickedHandle = e.target.classList.contains('handle');
  const clickedGobj   = e.target.closest('.gobj');
  if (!clickedHandle && !clickedGobj) deselectAll();
});

// Toolbar buttons
function zShift(dir) {
  if (!selectedCat) return;
  const i = zOrder.indexOf(selectedCat), n = i + dir;
  if (n < 0 || n >= zOrder.length) return;
  zOrder.splice(i, 1); zOrder.splice(n, 0, selectedCat);
  applyZOrder();
}

function resetSelected() {
  if (!selectedCat) return;
  T[selectedCat] = { x:0, y:0, scale:1, rotate:0 };
  applyTransform(selectedCat);
  positionToolbar(selectedCat);
}

function clearSelected() {
  if (!selectedCat) return;
  current[selectedCat] = -1;
  applyOverlay(selectedCat); updateCounter(selectedCat); updateOutfitLabel(); renderInventory();
  deselectAll();
}

// â”€â”€ Drag / Scale / Rotate interactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInteractions(cat) {
  const gobj  = gobjs[cat];
  const layer = layers[cat];

  // â”€â”€ DRAG (body of gobj) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  gobj.addEventListener('mousedown', e => {
    if (e.target.classList.contains('handle')) return; // handled below
    selectLayer(cat);
    const sx = e.clientX, sy = e.clientY;
    const stx = T[cat].x,  sty = T[cat].y;

    const onMove = ev => {
      T[cat].x = stx + (ev.clientX - sx);
      T[cat].y = sty + (ev.clientY - sy);
      applyTransform(cat);
      positionToolbar(cat);
    };
    const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    e.preventDefault(); e.stopPropagation();
  });

  // Touch drag
  let tDragging = false, tPinching = false;
  let tsx, tsy, tstx, tsty, tsd, tss;

  gobj.addEventListener('touchstart', e => {
    if (e.target.classList.contains('handle')) return;
    selectLayer(cat);
    if (e.touches.length === 1) {
      tDragging = true;
      tsx = e.touches[0].clientX; tsy = e.touches[0].clientY;
      tstx = T[cat].x; tsty = T[cat].y;
    } else if (e.touches.length === 2) {
      tDragging = false; tPinching = true;
      tsd = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      tss = T[cat].scale;
    }
    e.preventDefault();
  }, { passive:false });

  gobj.addEventListener('touchmove', e => {
    if (tDragging && e.touches.length === 1) {
      T[cat].x = tstx + (e.touches[0].clientX - tsx);
      T[cat].y = tsty + (e.touches[0].clientY - tsy);
      applyTransform(cat); positionToolbar(cat);
    } else if (tPinching && e.touches.length === 2) {
      const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      T[cat].scale = Math.max(0.15, Math.min(3, tss * (d / tsd)));
      applyTransform(cat);
    }
    e.preventDefault();
  }, { passive:false });

  gobj.addEventListener('touchend', () => { tDragging = false; tPinching = false; });

  // â”€â”€ SCALE HANDLES (corners) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  layer.querySelectorAll('.handle[data-dir="scale"]').forEach(handle => {
    handle.addEventListener('mousedown', e => {
      e.stopPropagation(); e.preventDefault();
      selectLayer(cat);

      const corner  = handle.dataset.corner;
      const startX  = e.clientX;
      const startY  = e.clientY;
      const startScale = T[cat].scale;
      const stackRect  = modelStack.getBoundingClientRect();
      const stackSize  = Math.min(stackRect.width, stackRect.height);

      // center of the gobj in screen coords
      const gobjRect = gobj.getBoundingClientRect();
      const cx = gobjRect.left + gobjRect.width / 2;
      const cy = gobjRect.top  + gobjRect.height / 2;
      const startDist = Math.hypot(startX - cx, startY - cy);

      const onMove = ev => {
        const dist = Math.hypot(ev.clientX - cx, ev.clientY - cy);
        T[cat].scale = Math.max(0.15, Math.min(3, startScale * (dist / startDist)));
        applyTransform(cat);
      };
      const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    });
  });

  // â”€â”€ ROTATE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rotHandle = layer.querySelector('.handle[data-dir="rotate"]');
  rotHandle.addEventListener('mousedown', e => {
    e.stopPropagation(); e.preventDefault();
    selectLayer(cat);

    const gobjRect = gobj.getBoundingClientRect();
    const cx = gobjRect.left + gobjRect.width  / 2;
    const cy = gobjRect.top  + gobjRect.height / 2;
    const startAngle = Math.atan2(e.clientY - cy, e.clientX - cx) * 180 / Math.PI;
    const startRot   = T[cat].rotate;

    const onMove = ev => {
      const angle = Math.atan2(ev.clientY - cy, ev.clientX - cx) * 180 / Math.PI;
      T[cat].rotate = startRot + (angle - startAngle);
      applyTransform(cat);
    };
    const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  });

  // Touch rotate handle
  rotHandle.addEventListener('touchstart', e => {
    e.stopPropagation(); e.preventDefault();
    selectLayer(cat);
    const gobjRect = gobj.getBoundingClientRect();
    const cx = gobjRect.left + gobjRect.width  / 2;
    const cy = gobjRect.top  + gobjRect.height / 2;
    const t0 = e.touches[0];
    const startAngle = Math.atan2(t0.clientY - cy, t0.clientX - cx) * 180 / Math.PI;
    const startRot   = T[cat].rotate;

    const onMove = ev => {
      const t = ev.touches[0];
      const angle = Math.atan2(t.clientY - cy, t.clientX - cx) * 180 / Math.PI;
      T[cat].rotate = startRot + (angle - startAngle);
      applyTransform(cat);
    };
    const onEnd = () => { window.removeEventListener('touchmove', onMove); window.removeEventListener('touchend', onEnd); };
    window.addEventListener('touchmove', onMove, { passive:false });
    window.addEventListener('touchend', onEnd);
  }, { passive:false });
}

['tops','bottoms','shoes'].forEach(setupInteractions);

// â”€â”€ Wardrobe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function swipe(cat, dir) {
  const items = wardrobe[cat]; if (!items.length) return;
  let idx = current[cat] + dir;
  if (idx < -1) idx = items.length - 1;
  if (idx >= items.length) idx = -1;
  current[cat] = idx;
  applyOverlay(cat); updateCounter(cat); updateOutfitLabel(); renderInventory();
  if (idx >= 0) selectLayer(cat); else deselectAll();
}

function jumpTo(cat, idx) {
  current[cat] = idx;
  applyOverlay(cat); updateCounter(cat); updateOutfitLabel(); renderInventory();
  selectLayer(cat);
}

function applyOverlay(cat) {
  const idx = current[cat];
  if (idx === -1) { imgs[cat].src = ''; layers[cat].classList.remove('on'); }
  else            { imgs[cat].src = wardrobe[cat][idx].url; layers[cat].classList.add('on'); }
}

function updateCounter(cat) {
  const items = wardrobe[cat], idx = current[cat];
  ctrs[cat].textContent = items.length ? (idx===-1 ? `â€”/${items.length}` : `${idx+1}/${items.length}`) : 'â€”';
}

function updateOutfitLabel() {
  const parts = [];
  if (current.tops>=0)    parts.push(wardrobe.tops[current.tops].name);
  if (current.bottoms>=0) parts.push(wardrobe.bottoms[current.bottoms].name);
  if (current.shoes>=0)   parts.push(wardrobe.shoes[current.shoes].name);
  outfitLabel.textContent = parts.length ? parts.join(' Â· ') : 'no outfit selected';
}

let pendingCat = null;
function addItem(cat) { pendingCat = cat; itemFileInput.value = ''; itemFileInput.click(); }

itemFileInput.addEventListener('change', e => {
  const f = e.target.files[0]; if (!f || !pendingCat) return;
  const url  = URL.createObjectURL(f);
  const name = f.name.replace(/\.[^.]+$/,'').replace(/[-_]/g,' ');
  wardrobe[pendingCat].push({ url, name });
  current[pendingCat] = wardrobe[pendingCat].length - 1;
  applyOverlay(pendingCat); updateCounter(pendingCat); updateOutfitLabel(); renderInventory();
  selectLayer(pendingCat);
});

function removeItem(cat, idx, e) {
  e.stopPropagation();
  wardrobe[cat].splice(idx, 1);
  if (current[cat] >= wardrobe[cat].length) current[cat] = wardrobe[cat].length - 1;
  applyOverlay(cat); updateCounter(cat); updateOutfitLabel(); renderInventory();
}

function renderInventory() {
  const cat = activeTab, items = wardrobe[cat];
  drawerBody.innerHTML = '';
  items.forEach((item, i) => {
    const el = document.createElement('div');
    el.className = 'inv-item' + (current[cat]===i ? ' active' : '');
    el.innerHTML = `<img src="${item.url}" alt="${item.name}"><div class="rx" onclick="removeItem('${cat}',${i},event)">âœ•</div>`;
    el.addEventListener('click', () => jumpTo(cat, i));
    drawerBody.appendChild(el);
  });
  const ab = document.createElement('div');
  ab.className = 'add-btn';
  ab.innerHTML = `<span>ï¼‹</span><p>Add ${cat.slice(0,-1)}</p>`;
  ab.onclick = () => addItem(cat);
  drawerBody.appendChild(ab);
}

function switchTab(cat) {
  activeTab = cat;
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('dtab-'+cat).classList.add('active');
  renderInventory();
}

function toggleDrawer() { document.getElementById('drawer').classList.toggle('collapsed'); }

applyZOrder();
renderInventory();
['tops','bottoms','shoes'].forEach(updateCounter);
</script>
</body>
</html>
